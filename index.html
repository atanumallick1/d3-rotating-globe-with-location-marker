<!DOCTYPE html>
<html>
  <body>
      <svg></svg>
      <script src="https://d3js.org/d3.v4.min.js"></script>
      <script src="https://d3js.org/topojson.v1.min.js"></script>
      <script>
          const width = 950;
          const height = 500;
          const svg = d3.select('svg')
              .attr('width', width).attr('height', height);
          const markerGroup = svg.append('g');
          const projection = d3.geoOrthographic();
          const initialScale = projection.scale();
          const path = d3.geoPath().projection(projection);
          const center = [width/2, height/2];

          drawMap();
          drawGraticule();
          drawMarkers();
          enableRotation();

          function drawMap() {            
              d3.json("https://gist.githubusercontent.com/mbostock/4090846/raw/d534aba169207548a8a3d670c9c2cc719ff05c47/world-110m.json", function (error, data) {
                  svg.selectAll(".segment")
                      .data(topojson.feature(data, data.objects.countries).features)
                      .enter().append("path")
                      .attr("class", "segment")
                      .attr("d", path)
                      .style("stroke", "#888")
                      .style("stroke-width", "1px")
                      .style("fill", (d, i) => '#e5e5e5')
                      .style("opacity", ".6");
              });
          }

          function drawGraticule() {
              const graticule = d3.geoGraticule()
                  .step([10, 10]);

              svg.append("path")
                  .datum(graticule)
                  .attr("class", "graticule")
                  .attr("d", path)
                  .style("fill", "#fff")
                  .style("stroke", "#ccc");
          }

          function enableRotation() {
              d3.timer(function (elapsed) {
                  projection.rotate([.005 * elapsed - 120, -30, 0]);
                  svg.selectAll("path").attr("d", path);
                  drawMarkers();
              });
          }        

          function drawMarkers() {
              d3.json('locations.json', (data) => {
                  const markers = markerGroup.selectAll('circle')
                      .data(data);
                  markers
                      .enter()
                      .append('circle')
                      .merge(markers)
                      .attr('cx', d => projection([d.longitude, d.latitude])[0])
                      .attr('cy', d => projection([d.longitude, d.latitude])[1])
                      .attr('fill', d => {
                          const coordinate = [d.longitude, d.latitude];
                          gdistance = d3.geoDistance(coordinate, projection.invert(center));
                          return gdistance > 1.57 ? 'none' : 'steelblue';
                      })
                      .attr('r', 7);

                  markerGroup.each(function () {
                      this.parentNode.appendChild(this);
                  });
              });              
          }
      </script>
  </body>
</html>